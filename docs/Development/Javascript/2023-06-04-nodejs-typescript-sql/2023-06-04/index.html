<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Development/Javascript/2023-06-04-nodejs-typescript-sql/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Node / Express with Typescript - (Re)Introduction 2023 | Mike Polinowski</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://mpolinowski.github.io/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/2023-06-04"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Node / Express with Typescript - (Re)Introduction 2023 | Mike Polinowski"><meta data-rh="true" name="description" content="Part 1 - Building a Node.js, Express.js App with a MySQL Backend."><meta data-rh="true" property="og:description" content="Part 1 - Building a Node.js, Express.js App with a MySQL Backend."><link data-rh="true" rel="icon" href="/img/icons/favicon-32x32.png"><link data-rh="true" rel="canonical" href="https://mpolinowski.github.io/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/2023-06-04"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/2023-06-04" hreflang="en"><link data-rh="true" rel="alternate" href="https://mpolinowski.github.io/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/2023-06-04" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Mike Polinowski RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Mike Polinowski Atom Feed">




<link rel="icon" href="/img/angular_momentum.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37,194,160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/angular_momentum.png">
<link rel="mask-icon" href="/img/angular_momentum.png" color="rgb(33,33,33)">
<meta name="msapplication-TileImage" content="/img/angular_momentum.png">
<meta name="msapplication-TileColor" content="#000">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P74BDWF0C6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-P74BDWF0C6",{})</script><link rel="stylesheet" href="/assets/css/styles.dcca9435.css">
<script src="/assets/js/runtime~main.9a0cc3b5.js" defer="defer"></script>
<script src="/assets/js/main.6d14a3ae.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_gu5v" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_ZRzL themedComponent--light_dGsa"><img src="/img/angular_momentum.png" alt="Mike Polinowski :: Dev Notebook" class="themedComponent_ZRzL themedComponent--dark_pzCA"></div><b class="navbar__title text--truncate">Mike Polinowski</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/tags">Tags</a><a class="navbar__item navbar__link" href="/Search">Search</a><a href="https://mpolinowski.github.io/Personal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">About<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_kWbt colorModeToggle_GwZs"><button class="clean-btn toggleButton_fOL9 toggleButtonDisabled_STpu" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_DCeJ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_DFgp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_IP3a"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_IbdI"><div class="docsWrapper_JGIH"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_SdI4" type="button"></button><div class="docRoot_eRbX"><aside class="theme-doc-sidebar-container docSidebarContainer_Ta75"><div class="sidebarViewport_fgog"><div class="sidebar_oDHW"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_vPEQ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/development">Development</a><button aria-label="Collapse sidebar category &#x27;Development&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/javascript">Javascript</a><button aria-label="Collapse sidebar category &#x27;Javascript&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/2023-06-04">Node / Express with Typescript - (Re)Introduction 2023</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2023-04-01-reactjs-2023/2023-04-01">React.js 2023 - A (Re)Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2023-02-13-gatsby-meili-search-starter/2023-02-13">MeiLi Search for your Gatsby.js Blog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2023-02-12-react-meili-search-starter/2023-02-12">React Frontend for MeiLi Search</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-12-29-reactive-search-starter/2022-12-29">Reactive Search Starter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-12-11-11ty-starter/2022-12-11">11ty Static Site Generator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-11-29-react-typescript-intro-2023/2022-11-29">TypeScript 2.0 in React 19 (2023)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-11-19-web3-javascript-app/2022-11-19">Web3.js Blockchain Application</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/2022-11-10">WebRTC Introduction - Interactive Connectivity Establishment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-10-30-webrtc-introduction-video-chat-part1/2022-10-30">WebRTC Introduction - Client Side Signalling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/2022-10-29">WebRTC Introduction - Realtime Chat</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-07-01-docusaurus-introduction/2022-07-01">Docusaurus Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2022-03-01--json-apis-training/2022-03-01">Working with JSON APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-10--websocket-recconects/2021-09-10">Reconnecting Websockets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-10--notifications-alerts-as-toast/2021-09-10">Convert Alerts into Toasts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-09--websocket-NGINX/2021-09-09">NGINX as a Proxy for Websockets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-09--websocket-HAproxy/2021-09-09">HAProxy Loadbalancing and Websockets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-08--websockets-html-video/2021-09-08">HTML Video over Websockets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-09-07--intro-to-websockets/2021-09-07">Introduction to Websockets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-06-04--mqtt-dashboard-react/2021-06-04">React Dashboard for MQTT</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-06-02--mqtt-cheat-sheet/2021-06-02">Mosquitto MQTT Cheat Sheet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-06-01--mqtt-with-reactjs/2021-06-01">MQTT Webfrontend with React.js</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-12-carbon-design-react-part3/2021-05-12">Carbon Design System in React.js - Part III</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-11-carbon-design-react-part2/2021-05-11">Carbon Design System in React.js - Part II</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-10-carbon-design-react/2021-05-10">Carbon Design System in React.js - Part I</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-09-electron13-and-react/2021-05-09">Electron@13 and Create-React-App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-08-electron13-gatsby-wrapper/2021-05-08">Electron@13 as a Gatsby.js Wrapper</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-05-07-electron-cross-platform-apps/2021-05-07">Electron for Cross Platform Applications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2021-02-14-next-js-2021/2021-02-14">Next.js in 2021</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2020-01-12--node-express-redirect-server/2020-01-12">Web traffic redirection with Node and Express on CentOS8</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2019-08-02--building-an-mqtt-interface/2019-08-02">Building a MQTT Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2018-01-17--server-side-render-react-router/2018-01-17">Server Rendering with React and React Router</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2018-01-15--react-transition-group-demo/2018-01-15">react-transition-group</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2018-01-07--gatsby-material-ui-starter/2018-01-07">Gatsby Material UI Starter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-12-17--gatsby-reactstrap/2017-12-17">Gatsby.js with Bootstrap 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-12-14--gatsby-wiki/2017-12-14">Gatsby.js Knowledgebase</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-12-09--next-start/2017-12-09">Next.js Server Side Rendering</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-12-07--react-router-4/2017-12-07">React Router 4</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-09-03--react-under-the-hood/2017-09-03">React under the Hood</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-08-21--reactive-material/2017-08-21">create-react-app and Material-UI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-08-15--gatsby-blog-starter/2017-08-15">Gatsby Blog Starter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-08-07--google-analytics-amp/2017-08-07">Google Analytics in AMP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-07-24--obligatory-react-todo-list/2017-07-24">React TODO List</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-07-22--caloric-burn/2017-07-22">Food Caloric Table App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2017-07-04--random-password-generator/2017-07-04">Random Password Generator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2016-08-11--node-express-static-wiki/2016-08-11">Node Express Static</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2016-06-01--node-express-mongodb/2016-06-01">Node/Express with MongoDB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2016-05-27--javascript-apis-and-ajax/2016-05-27">JavaScript and Getting Started with APIs and AJAX</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2010-01-05--markdown-live-code/2010-01-05">React-Live &amp; Code example</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Development/Javascript/2010-01-01--mdx/2010-01-01">Markdown Cheatsheet</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/python">Python</a><button aria-label="Expand sidebar category &#x27;Python&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/go">Go</a><button aria-label="Expand sidebar category &#x27;Go&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/graphs">Graphs</a><button aria-label="Expand sidebar category &#x27;Graphs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/react-native">React Native</a><button aria-label="Expand sidebar category &#x27;React Native&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/magento">Magento</a><button aria-label="Expand sidebar category &#x27;Magento&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/misc">Misc</a><button aria-label="Expand sidebar category &#x27;Misc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/devops">DevOps</a><button aria-label="Expand sidebar category &#x27;DevOps&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/machine-learning-ai-and-computer-vision">Machine Learning, AI and Computer Vision</a><button aria-label="Expand sidebar category &#x27;Machine Learning, AI and Computer Vision&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/automation-deep-vision-and-robotics">Automation, Deep Vision and Robotics</a><button aria-label="Expand sidebar category &#x27;Automation, Deep Vision and Robotics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_lg0V"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_nDJs"><div class="docItemContainer_OGiL"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_k3Z9" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JACu"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/development"><span itemprop="name">Development</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/javascript"><span itemprop="name">Javascript</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Node / Express with Typescript - (Re)Introduction 2023</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_QCOD theme-doc-toc-mobile tocMobile_N0YI"><button type="button" class="clean-btn tocCollapsibleButton_pHwF">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Node / Express with Typescript - (Re)Introduction 2023</h1></header><p><img alt="TST, Hongkong" src="/assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-c3aedc7eed015cc5372c21f9c394693d.jpg" width="2359" height="864"></p>
<ul>
<li><a href="#getting-started">Getting Started</a>
<ul>
<li><a href="#nodejs">Node.js</a></li>
<li><a href="#typescript">Typescript</a></li>
<li><a href="#nodemon">Nodemon</a></li>
</ul>
</li>
<li><a href="#webserver">Webserver</a>
<ul>
<li><a href="#expressjs">Express.js</a></li>
<li><a href="#express-router">Express Router</a></li>
<li><a href="#request-validation">Request Validation</a></li>
</ul>
</li>
<li><a href="#database">Database</a>
<ul>
<li><a href="#sql-database">SQL Database</a></li>
<li><a href="#mysql-connector">MySQL Connector</a></li>
</ul>
</li>
<li><a href="#authentication">Authentication</a>
<ul>
<li><a href="#registering-users">Registering Users</a></li>
<li><a href="#users-login">Users Login</a></li>
<li><a href="#json-web-tokens">JSON Web Tokens</a></li>
<li><a href="#authenticate-users">Authenticate Users</a></li>
<li><a href="#deauthenticate-users">Deauthenticate Users</a></li>
<li><a href="#dotenv">Dotenv</a></li>
<li><a href="#verify-auth-status-middleware">Verify Auth Status Middleware</a></li>
<li><a href="#update-user-info">Update User Info</a></li>
<li><a href="#user-administration">User Administration</a>
<ul>
<li><a href="#get-all-users">Get all Users</a></li>
<li><a href="#get-user-by-id">Get User by ID</a></li>
<li><a href="#create-user">Create User</a></li>
<li><a href="#update-user">Update User</a></li>
<li><a href="#delete-user">Delete User</a></li>
</ul>
</li>
<li><a href="#user-role-model">User Role Model</a>
<ul>
<li><a href="#user-permissions">User Permissions</a></li>
<li><a href="#pre-seeding-roles-and-permissions">Pre-Seeding Roles and Permissions</a></li>
<li><a href="#permissions-controller">Permissions Controller</a></li>
<li><a href="#role-controller">Role Controller</a>
<ul>
<li><a href="#manually-adding-roles">Manually Adding Roles</a></li>
<li><a href="#get-permissions-for-a-role">Get Permissions for a Role</a></li>
<li><a href="#update-permissions-for-a-role">Update Permissions for a Role</a></li>
<li><a href="#manually-deleting-roles">Manually Deleting Roles</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#products">Products</a>
<ul>
<li><a href="#product-controller">Product Controller</a></li>
<li><a href="#product-entity">Product Entity</a>
<ul>
<li><a href="#pre-seeding-products">Pre-Seeding Products</a></li>
</ul>
</li>
<li><a href="#pagination">Pagination</a></li>
<li><a href="#file-uploads">File Uploads</a>
<ul>
<li><a href="#static-routes">Static Routes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orders">Orders</a>
<ul>
<li><a href="#pre-seeding-orders">Pre-Seeding Orders</a></li>
<li><a href="#order-controller">Order Controller</a>
<ul>
<li><a href="#exporting-order-to-csv">Exporting Order to CSV</a></li>
<li><a href="#charting-order-data">Charting Order Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#route-permissions">Route Permissions</a>
<ul>
<li><a href="#update-role-seed">Update Role Seed</a></li>
<li><a href="#permission-middleware">Permission Middleware</a></li>
</ul>
</li>
</ul>
<h2 id="getting-started">Getting Started</h2>
<h3 id="nodejs">Node.js</h3>
<p>Install the <a href="https://nodejs.org/en">latest version of Node.js</a> and create a new Node project using npm:</p>
<pre><code class="language-bash">mkdir hello-next &amp;&amp; cd hello-next
npm init -y
</code></pre>
<p>Test your Node.js installation by creating a hello world js file:</p>
<pre><code class="language-bash">nano ./index.js
</code></pre>
<p>with the following content:</p>
<pre><code class="language-js">console.log(&#x27;Hello from Node.js&#x27;) 
</code></pre>
<p>Add a start script to <code>./package.json</code></p>
<pre><code class="language-json"> &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node index.js&quot;
  },
</code></pre>
<p>And execute it using npm:</p>
<pre><code class="language-bash"> npm start

&gt; hello-next@1.0.0 start
&gt; node index.js

Hello from Node.js
</code></pre>
<h3 id="typescript">Typescript</h3>
<pre><code class="language-bash">sudo npm install -g typescript 
npm install -D typescript ts-node nodemon
</code></pre>
<pre><code class="language-bash">tsc --init

Created a new tsconfig.json with:

TS
  target: es2016
  module: commonjs
  strict: true
  esModuleInterop: true
  skipLibCheck: true
  forceConsistentCasingInFileNames: true
</code></pre>
<p>Move the index file into a src sub-directory and rename the file to <code>index.ts</code> and change the npm script to <code>&quot;start&quot;: &quot;ts-node src/index.ts&quot;</code>. Verify that everything still works:</p>
<pre><code class="language-bash">npm start

&gt; hello-next@1.0.0 start
&gt; ts-node index.ts

Hello from Node.js
</code></pre>
<h3 id="nodemon">Nodemon</h3>
<p>For development we can use <code>&quot;dev&quot;: &quot;nodemon src/index.ts&quot;</code> to get live reloading with the following configuration:</p>
<pre><code class="language-bash">nano nodemon.json
</code></pre>
<pre><code class="language-json">{
    &quot;ignore&quot;: [
        &quot;.git&quot;,
        &quot;node_modules/&quot;,
        &quot;dist/&quot;,
        &quot;coverage/&quot;
    ],
    &quot;watch&quot;: [
        &quot;src/*&quot;
    ],
    &quot;ext&quot;: &quot;js, json, ts&quot;
}
</code></pre>
<pre><code class="language-bash">npm run dev

&gt; hello-next@1.0.0 dev
&gt; nodemon src/index.ts

[nodemon] 2.0.22
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): src/**/*
[nodemon] watching extensions: js,json,ts
[nodemon] starting `ts-node src/index.ts`
Hello from Node.js
[nodemon] clean exit - waiting for changes before restart
</code></pre>
<h2 id="webserver">Webserver</h2>
<h3 id="expressjs">Express.js</h3>
<pre><code class="language-bash">npm install express cors
npm install -D @types/express @types/cors
</code></pre>
<p>Clean out the index file and replace it with the Express boilerplate:</p>
<pre><code class="language-js">import express, {Request, Response} from &#x27;express&#x27;
import cors from &#x27;cors&#x27;

const expressPort = 8888;
const app = express();

// use json for API routes
app.use(express.json());
// cors for api address/port
app.use(cors({
    credentials: true,
    origin: [&quot;http://localhost:3000&quot;]
}));

app.get(&#x27;/&#x27;, (req: Request, res: Response) =&gt; {
    res.send(&#x27;INFO :: Root route called&#x27;);
});

app.listen(expressPort, () =&gt; {
    console.log(&#x27;INFO :: Webserver started on port &#x27; + expressPort)
});
</code></pre>
<p>Test that the root route is working:</p>
<pre><code class="language-bash">curl localhost:8888
INFO :: Root route called
</code></pre>
<h3 id="express-router">Express Router</h3>
<p>Above we created a route inside the index file. But Express allows us to export routes as well as controller functions - e.g. authentication - from separate files to keep things tidy:</p>
<pre><code class="language-bash">nano src/routes.ts
</code></pre>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register } from &#x27;./controller/auth.controller&#x27;

export const routes = (router: Router) =&gt; {
    router.post(&#x27;/api/register&#x27;, Register)
}
</code></pre>
<pre><code class="language-bash">nano src/controller/auth.controller.ts
</code></pre>
<pre><code class="language-js">import { Request, Response } from &#x27;express&#x27;;

export const Register = (req: Request, res: Response) =&gt; {
    res.send(req.body);
};
</code></pre>
<p>The routes can now be imported into your index file:</p>
<pre><code class="language-js">import { routes } from &#x27;./routes&#x27;;

// import routes from router
routes(app)
</code></pre>
<p>We can now test the registration URL:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;username&quot;:&quot;itsme&quot;,&quot;password&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/register
</code></pre>
<p>This returns the JSON body <code>{&quot;username&quot;:&quot;itsme&quot;,&quot;password&quot;:&quot;secret&quot;}</code> as configured.</p>
<h3 id="request-validation">Request Validation</h3>
<p>Use the express request-validation inside your authentication controller to verify that an incoming request is valid:</p>
<pre><code class="language-bash">npm install express-validation
</code></pre>
<pre><code class="language-bash">nano ./src/validation/register.validation.ts
</code></pre>
<pre><code class="language-js">import { Joi } from &#x27;express-validation&#x27;;

export const registerValidation = Joi.object({
    firstName: Joi.string().required(),
    lastName: Joi.string().required(),
    email: Joi.string().email().required(),
    password: Joi.string().required(),
    passwordConfirm: Joi.string().required(),
})
</code></pre>
<p>The validation can now be imported into the auth controller to return an error message if the validation fails:</p>
<p><em>src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &#x27;express&#x27;;
import { registerValidation } from &#x27;../validation/register.validation&#x27;;

export const Register = (req: Request, res: Response) =&gt; {
    const body = req.body;

    const { error } = registerValidation.validate(body);

    if (error) {
        return res.status(400).send(error.details);
    }

    if (body.password !== body.passwordConfirm){
        return res.status(400).send({
            message: &#x27;ERROR :: Passwords do not match!&#x27;
        });
    }
</code></pre>
<p>Test the validation with missing data and a valid request:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;firstName&quot;:&quot;its&quot;,&quot;lastName&quot;:&quot;me&quot;,&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/register
</code></pre>
<pre><code class="language-bash">[{&quot;message&quot;:&quot;\&quot;passwordConfirm\&quot; is required&quot;,&quot;path&quot;:[&quot;passwordConfirm&quot;],&quot;type&quot;:&quot;any.required&quot;,&quot;context&quot;:{&quot;label&quot;:&quot;passwordConfirm&quot;,&quot;key&quot;:&quot;passwordConfirm&quot;}}]
</code></pre>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;firstName&quot;:&quot;its&quot;,&quot;lastName&quot;:&quot;me&quot;,&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;,&quot;passwordConfirm&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/register
</code></pre>
<pre><code class="language-bash">{&quot;firstName&quot;:&quot;its&quot;,&quot;lastName&quot;:&quot;me&quot;,&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;,&quot;passwordConfirm&quot;:&quot;secret&quot;}
</code></pre>
<h2 id="database">Database</h2>
<h3 id="sql-database">SQL Database</h3>
<p>Bring up an SQL database to handle your app data, e.g. with Docker-Compose:</p>
<p><em>./src/docker/docker-compose.yml</em></p>
<pre><code class="language-yml">version: &#x27;3&#x27;

services:

  db:
    image: mariadb
    restart: always
    ports:
      - 3306:3306
    environment:
      MARIADB_ROOT_PASSWORD: secretpassword
      MARIADB_DATABASE: react-app
      MARIADB_USER: app-user
      MARIADB_PASSWORD: secretpassword

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
</code></pre>
<p>You can login on port <code>8080</code> to verify that MariaDB is up and the app database was created:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_01-7a92758efc74eac0e643f1af094d9d66.png" width="915" height="338"></p>
<h3 id="mysql-connector">MySQL Connector</h3>
<p>Now we need to connect the app to freshly created database:</p>
<pre><code class="language-bash">npm install typeorm reflect-metadata @types/node mysql2 bcryptjs @types/bcryptjs
</code></pre>
<p>To keep things simple we can move the entire DB logic into it&#x27;s own file:</p>
<p><em>./src/db-connector.ts</em></p>
<pre><code class="language-js">import { DataSource } from &quot;typeorm&quot;;
const dataSourceOptions = require(&#x27;../dataSourceOptions.json&#x27;)

export const dataSource = new DataSource(dataSourceOptions);

export const Manager = dataSource.manager
// export const UserRepository = dataSource.getRepository(User)

dataSource
    .initialize()
    .then(() =&gt; {
        console.log(&#x27;INFO :: Data Source has been initialized&#x27;);
    })
    .catch((err) =&gt; {
        console.error(&#x27;ERROR :: Data Source initialization error&#x27;, err);
    })

export default dataSource;
</code></pre>
<p>The database configuration is exported into a separate JSON file for convenience:</p>
<p><em>./dataSourceOptions.json</em></p>
<pre><code class="language-json">{
    &quot;type&quot;: &quot;mysql&quot;,
    &quot;host&quot;: &quot;localhost&quot;,
    &quot;port&quot;: 3306,
    &quot;username&quot;: &quot;app-user&quot;,
    &quot;password&quot;: &quot;secretpassword&quot;,
    &quot;database&quot;: &quot;react-app&quot;,
    &quot;entities&quot;: [
        &quot;src/entities/*.ts&quot;
    ],
    &quot;logging&quot;: false,
    &quot;synchronize&quot;: true
}
</code></pre>
<blockquote>
<p><strong>NOTE</strong> that the configuration here has to match up with the configuration set inside the Docker-Compose file you used to start your instance of MariaDB!</p>
</blockquote>
<p>The connector can be imported into the index file before calling the Express app - to make sure that the DB connection is establish before the app starts:</p>
<p><em>./src/index.ts</em></p>
<pre><code class="language-js">// Import DB config
import dataSource from &quot;./db-connector&quot;;
// Create connection with DB
dataSource
</code></pre>
<p>The connector now only connects us to our database. To have actually do something we have to add &quot;entities&quot; in the configured entity folder <code>src/entities/*.ts</code>:</p>
<p><em>./src/entities/user.entity.ts</em></p>
<pre><code class="language-js">import { Column, PrimaryGeneratedColumn, Entity } from &quot;typeorm&quot;;

@Entity()
export class User {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

    @Column({
        unique: true
    })
    email: string;

    @Column()
    password: string;

}
</code></pre>
<p>This will make sure that the user table is generated as soon as the app is restarted:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_02-7579ffc8c50c6149661a4b609c488bd5.png" width="1190" height="566"></p>
<h2 id="authentication">Authentication</h2>
<h3 id="registering-users">Registering Users</h3>
<p>To be able to populate the User table with user logins we now have to add a function to the auth controller:</p>
<p><em>src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">// REGISTER USER
export const Register = async (req: Request, res: Response) =&gt; {
    const body = req.body;

    // check if all infos were send
    const { error } = registerValidation.validate(body);
    // break if something is missing
    if (error) {
        return res.status(400).send(error.details);
    }
    // verify that password is confirmed
    if (body.password !== body.passwordConfirm){
        return res.status(400).send({
            message: &#x27;ERROR :: Passwords do not match!&#x27;
        });
    }
    // save password to database
    const { password, ...user } = await repository.save({
        firstName: body.firstName,
        lastName: body.lastName,
        email: body.email,
        password: await bcryptjs.hash(body.password, 10)
    })

    res.send(user);
};
</code></pre>
<p>Here I am using bcryptjs to make sure that the password is not stored in plain text. The user registration can be tested using curl:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;firstName&quot;:&quot;Mike&quot;,&quot;lastName&quot;:&quot;Polinowski&quot;,&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;,&quot;passwordConfirm&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/register
</code></pre>
<p>Note that the password in the returned body is hashed and also received an ID - the first user registered in the User table:</p>
<pre><code class="language-bash">{&quot;firstName&quot;:&quot;Mike&quot;,&quot;lastName&quot;:&quot;Polinowski&quot;,&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;$2a$10$6LKB6iIhOjzK7TK3kv1qeOOYkds6mvh1JENfzJDFqtnY3wR999Ue2&quot;,&quot;id&quot;:1}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_03-bfdce0e8e02828c90b1615835918b9c7.png" width="1184" height="412"></p>
<h3 id="users-login">Users Login</h3>
<p>Create a login route that points to a function called Login in the auth controller:</p>
<p><em>./src/routes.ts</em></p>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register, Login } from &#x27;./controller/auth.controller&#x27;

export const routes = (router: Router) =&gt; {
    router.post(&#x27;/api/register&#x27;, Register)
    router.post(&#x27;/api/login&#x27;, Login)
}
</code></pre>
<p>And create the login function:</p>
<p><em>./src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">// LOGIN USER
export const Login = async (req: Request, res: Response) =&gt; {
    // check if user exists in db
    const user = await repository.findOneBy(
            {
                email: req.body.email
            }
        )
    
    // if does not exists break
    if(!user){
        return res.status(404).send({
            message: &#x27;ERROR :: User does not exists!&#x27;
        })
    }

    // if exists but password is wrong break
    if(!await bcryptjs.compare(req.body.password, user.password)) {
        return res.status(404).send({
            message: &#x27;ERROR :: Invalid credentials!&#x27;
        })
    }

    // don&#x27;t return password after successful login
    const { password, ...data } = user;
    res.send(user);
}
</code></pre>
<p>Again, we can test the user login with curl:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/login

{&quot;id&quot;:1,&quot;firstName&quot;:&quot;Mike&quot;,&quot;lastName&quot;:&quot;Polinowski&quot;,&quot;email&quot;:&quot;me@email.com&quot;}
</code></pre>
<h3 id="json-web-tokens">JSON Web Tokens</h3>
<p>Return a JWT to keep users authenticated after a successful login:</p>
<pre><code class="language-bash">npm install jsonwebtoken @types/jsonwebtoken cookie-parser @types/cookie-parser
</code></pre>
<p>Instead of returning the user we now need to return a JWT in Login function:</p>
<p><em>./src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">// return JWT to authenticated user
const payload = { id: user.id }
const token = sign(payload, &#x27;secretkey&#x27;)

// don&#x27;t return password after successful login
// const { password, ...data } = user;
res.send(token);
</code></pre>
<p>Test that the login now returns the token:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/login

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiaWF0IjoxNjg1ODkwNjIxfQ.W8D81og0GuWZ8Q8Nvp1XDpqK0XwDFXy0qYgjXxP8uno
</code></pre>
<p>Write token to HTTP cookie instead of returning it directly:</p>
<pre><code class="language-js">// return JWT to authenticated user
const token = sign(
    {
        id: user.id
    }, &#x27;secretkey&#x27;
)

res.cookie(&#x27;jwt&#x27;, token, {
    // keep cookie in node.js backend
    httpOnly: true,
    maxAge: 24*60*60*1000 //1day
})

res.send({
    message: &#x27;INFO :: Successfully logged in.&#x27;
})
</code></pre>
<p>Try the login again:</p>
<pre><code class="language-bash">curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data &#x27;{&quot;email&quot;:&quot;me@email.com&quot;,&quot;password&quot;:&quot;secret&quot;}&#x27; \
  http://localhost:8888/api/login

{&quot;message&quot;:&quot;INFO :: Successfully logged in.&quot;}
</code></pre>
<h3 id="authenticate-users">Authenticate Users</h3>
<p>Start by creating a route for returning the authenticated user:</p>
<p><em>./src/routes.ts</em></p>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register, Login, AuthenticatedUser } from &#x27;./controller/auth.controller&#x27;

export const routes = (router: Router) =&gt; {
    // register new user
    router.post(&#x27;/api/register&#x27;, Register)
    // login known user
    router.post(&#x27;/api/login&#x27;, Login)
    // get authenticated user from jwt
    router.get(&#x27;/api/user&#x27;, AuthenticatedUser)
}
</code></pre>
<p>Then create the referenced function for this route:</p>
<p><em>./src/controller/auth.controller</em></p>
<pre><code class="language-js">export const AuthenticatedUser = async (req: Request, res: Response) =&gt; {
    // get cookie from authenticated user
    const jwt = req.cookies[&#x27;jwt&#x27;];
    // get user id from jwt
    const payload: any = verify(jwt, secret)

    if(!payload) {
        return res.status(401).send({
            message: &#x27;ERROR :: User unauthenticated!&#x27;
        })
    }
    // return user info  for user id
    const {password, ...user} = await repository.findOneBy(payload.id)

    res.send(user)
}
</code></pre>
<p>We can test the function in Postman by first logging in:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_04-0cf473d017775ee2d864e5efd36a712f.png" width="894" height="561"></p>
<p>And then calling the <code>/api/user</code> route with the received web token:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_05-31b698ea2ccd28cc159a12ddfc174e1b.png" width="888" height="604"></p>
<p>Our web token contained our user id that the backend could use to identify the authenticated user and return the user information.</p>
<h3 id="deauthenticate-users">Deauthenticate Users</h3>
<p>Once logged in we need to provide a function that allows us to remove the web token and log out the user. Start by providing a route:</p>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register, Login, AuthenticatedUser, Logout } from &#x27;./controller/auth.controller&#x27;

export const routes = (router: Router) =&gt; {
    // register new user
    router.post(&#x27;/api/register&#x27;, Register)
    // login known user
    router.post(&#x27;/api/login&#x27;, Login)
    // get authenticated user from jwt
    router.get(&#x27;/api/user&#x27;, AuthenticatedUser)
    // force expire jwt to log out
    router.post(&#x27;/api/logout&#x27;, Logout)
}
</code></pre>
<p>To logout we need to expire the active JWT:</p>
<p><em>./src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">export const Logout = async (req: Request, res: Response) =&gt; {
    res.cookie(&#x27;jwt&#x27;, &#x27;&#x27;,  {maxAge: 0})

    res.send({
        message: &#x27;INFO :: Successfully logged out.&#x27;
    })
}
</code></pre>
<p>The function can be verified with Postman:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_06-86f94341683f7ec15c27efec2686bcc7.png" width="898" height="554"></p>
<h3 id="dotenv">Dotenv</h3>
<p>Using dot environment variables to pass in global variables like the JWT <code>secretkey</code>:</p>
<pre><code class="language-bash">npm install dotenv @types/dotenv
</code></pre>
<p>Collect all global variables in a dotenv file:</p>
<p><em>./.env</em></p>
<pre><code class="language-bash"># Express webfrontend port
WEB_PORT = 8888
# JWT secret key 
SECRET_KEY = &#x27;secretkey&#x27;
# API url for CORS
API_URL = &#x27;http://localhost:3000&#x27;
# Datasource options for TypeORM
DS_HOST = &#x27;localhost&#x27;
DS_USER = &#x27;app-user&#x27;
DS_PASS = &#x27;secretpassword&#x27;
DS_DB = &#x27;react-app&#x27;
DS_ENTITIES = &#x27;src/entities/*.ts&#x27;
</code></pre>
<p>And require the configuration file <strong>ON TOP</strong> of your index file:</p>
<pre><code class="language-js">require(&#x27;dotenv&#x27;).config();
</code></pre>
<p>Now you are able to use these variables in your entire app:</p>
<p><em>./src/index.ts</em></p>
<pre><code class="language-js">const apiUrl = process.env.API_URL;
const expressPort = process.env.WEB_PORT || 8080;
</code></pre>
<p><em>./src/db-connector.ts</em></p>
<pre><code class="language-js">export const dataSource = new DataSource({
    type: &#x27;mariadb&#x27;,
    host: process.env.DS_HOST,
    port: 3306,
    username: process.env.DS_USER,
    password: process.env.DS_PASS,
    database: process.env.DS_DB,
    entities: [process.env.DS_ENTITIES],
    logging: false,
    synchronize: true
  });
</code></pre>
<h3 id="verify-auth-status-middleware">Verify Auth Status Middleware</h3>
<p>Move the auth status check into middleware to simplify the <strong>AuthenticatedUser</strong> function that should only return the user details of authenticated users:</p>
<p><em>src/middleware/auth.middleware.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &#x27;express&#x27;;
import { verify } from &#x27;jsonwebtoken&#x27;;

import Manager from &#x27;../db-connector&#x27;;
import { User } from &#x27;../entities/user.entity&#x27;;
const secret = process.env.SECRET_KEY

const repository = Manager.getRepository(User);

export const CheckAuthState = async (req: Request, res: Response, next: Function) =&gt; {
    
        try {
            // get cookie from authenticated user
            const jwt = req.cookies[&#x27;jwt&#x27;];
            // get user id from jwt
            const payload: any = verify(jwt, secret)

            if(!payload) {
                return res.status(401).send({
                    message: &#x27;ERROR :: User unauthenticated!&#x27;
                })
            }
            // return user info  for user id
            req[&#x27;user&#x27;] = await repository.findOneBy(payload.id)

            next();

        } catch (e) {
            return res.status(401).send({
                message: &#x27;ERROR :: User unauthenticated!&#x27;
        })
    }
}
</code></pre>
<p>The entire verification logic now moved into the middleware. By adding it to our user and logout route we can now directly request the user details inside the auth controller:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register, Login, AuthenticatedUser, Logout } from &#x27;./controller/auth.controller&#x27;
import { CheckAuthState } from &#x27;./middleware/auth.middleware&#x27;

export const routes = (router: Router) =&gt; {
    // register new user
    router.post(&#x27;/api/register&#x27;, Register)
    // login known user
    router.post(&#x27;/api/login&#x27;, Login)
    // get authenticated user from jwt
    router.get(&#x27;/api/user&#x27;, CheckAuthState, AuthenticatedUser)
    // force expire jwt to log out
    router.post(&#x27;/api/logout&#x27;, CheckAuthState, Logout)
}
</code></pre>
<p><em>src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">// RETURN USER DATA BY JWT ID
export const AuthenticatedUser = async (req: Request, res: Response) =&gt; {
    const {password, ...user} = req[&#x27;user&#x27;]
    res.send(user);
}
</code></pre>
<h3 id="update-user-info">Update User Info</h3>
<p>Add two more routes to update the user name and password:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">import { Router } from &#x27;express&#x27;;
import { Register, Login, AuthenticatedUser, Logout, UpdateUserInfo, UpdateUserPass } from &#x27;./controller/auth.controller&#x27;
import { CheckAuthState } from &#x27;./middleware/auth.middleware&#x27;

export const routes = (router: Router) =&gt; {
    // register new user
    router.post(&#x27;/api/register&#x27;, Register)
    // login known user
    router.post(&#x27;/api/login&#x27;, Login)
    // get authenticated user from jwt
    router.get(&#x27;/api/user&#x27;, CheckAuthState, AuthenticatedUser)
    // force expire jwt to log out
    router.post(&#x27;/api/logout&#x27;, CheckAuthState, Logout)
    // update user info
    router.put(&#x27;/api/users/info&#x27;, CheckAuthState, UpdateUserInfo)
    // update user password
    router.put(&#x27;/api/users/pass&#x27;, CheckAuthState, UpdateUserPass)
}
</code></pre>
<p>And add the corresponding controller functions:</p>
<p><em>src/controller/auth.controller.ts</em></p>
<pre><code class="language-js">// UPDATE USER INFO
export const UpdateUserInfo = async (req: Request, res: Response) =&gt; {

    const user = req[&#x27;user&#x27;];

    await repository.update(user.id, req.body)

    const { password, ...data } = await repository.findOneBy(user.id)

    res.send({data})
}

// UPDATE USER PASSWORD
export const UpdateUserPass = async (req: Request, res: Response) =&gt; {

    const user = req[&#x27;user&#x27;];

    // verify that password is confirmed
    if (req.body.password !== req.body.passwordConfirm){
        return res.status(400).send({
            message: &#x27;ERROR :: Passwords do not match!&#x27;
        });
    }

    await repository.update(user.id, {
        password: await bcryptjs.hash(req.body.password, 10)
    })

    const { password, ...data } = await repository.findOneBy(user.id)

    res.send({data})
}
</code></pre>
<p>Use the <code>/api/users/info</code> route to update the user name and email:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_07-8a61d67e410b0f3236f8297549e2025f.png" width="894" height="687"></p>
<p>And <code>/api/users/pass</code> to update the user password:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_08-96a85fdcad601e2ebe03df6dbe1c3aad.png" width="893" height="689"></p>
<h3 id="user-administration">User Administration</h3>
<p>The admin user has to be able to administer other users. Start by creating routes that:</p>
<ul>
<li>fetch all registered users</li>
<li>fetch user by ID</li>
<li>create new users</li>
<li>update user</li>
<li>delete user</li>
</ul>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">export const routes = (router: Router) =&gt; {

    // register new user
    router.post(&#x27;/api/register&#x27;, Register)
    // login known user
    router.post(&#x27;/api/login&#x27;, Login)
    // get authenticated user from jwt
    router.get(&#x27;/api/user&#x27;, CheckAuthState, AuthenticatedUser)
    // force expire jwt to log out
    router.post(&#x27;/api/logout&#x27;, CheckAuthState, Logout)
    // update user info
    router.put(&#x27;/api/users/info&#x27;, CheckAuthState, UpdateUserInfo)
    // update user password
    router.put(&#x27;/api/users/pass&#x27;, CheckAuthState, UpdateUserPass)

    // user administration - get all users
    router.get(&#x27;/api/users&#x27;, CheckAuthState, GetUsers)
    // user administration - get user by ID
    router.get(&#x27;/api/users/:id&#x27;, CheckAuthState, GetUser)
    // user administration - create new user
    router.put(&#x27;/api/users/:id&#x27;, CheckAuthState, UpdateUser)
    // user administration - create new user
    router.post(&#x27;/api/users&#x27;, CheckAuthState, CreateUser)
    // user administration - delete user
    router.delete(&#x27;/api/users/:id&#x27;, CheckAuthState, DeleteUser)
}
</code></pre>
<h4 id="get-all-users">Get all Users</h4>
<p>The administration functions are collected in the user controller. The GetUsers function selects the user table and returns everything:</p>
<p><em>src/controller/controller.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &quot;express&quot;;


import Manager from &quot;../db-connector&quot;;
import { User } from &#x27;../entities/user.entity&#x27;;
const repository = Manager.getRepository(User);


export const GetUsers = async (req: Request, res: Response) =&gt; {
    const users = await repository.find()

    res.send(
        users.map(user =&gt; {
            //remove password
            const { password, ...data} = user
            return data
        })
    )
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_09-cbff2f1b7564467f8594fc3f7fffb977.png" width="892" height="700"></p>
<h4 id="get-user-by-id">Get User by ID</h4>
<p>To fetch the a single user we can add the user ID as request param:</p>
<p><em>src/controller/controller.controller.ts</em></p>
<pre><code class="language-js">export const GetUser = async (req: Request, res: Response) =&gt; {
    const {password, ...user} = await repository.findOne({ where: { id: req.params.id } })
    
    res.send(user)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_11-3b079824ce755ce678025f3897f4f867.png" width="886" height="607"></p>
<h4 id="create-user">Create User</h4>
<p>I already created the POST route to create new users in the previous step. Now the function for it is still missing:</p>
<p><em>src/controller/controller.controller.ts</em></p>
<pre><code class="language-js">export const CreateUser = async (req: Request, res: Response) =&gt; {
    const { role_id, ...body } = req.body;
    const hashedPassword = await bcryptjs.hash(&#x27;pass1234&#x27;, 10);
    const { password, ...user} = await repository.save({
        ...body,
        password: hashedPassword
    })

    res.status(201).send(user)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_10-1a91e089d38af33cfa5a8f43d56315e4.png" width="906" height="564"></p>
<h4 id="update-user">Update User</h4>
<p><em>src/controller/controller.controller.ts</em></p>
<pre><code class="language-js">export const UpdateUser = async (req: Request, res: Response) =&gt; {
    const { role_id, ...body } = req.body;
    const update = await repository.update(req.params.id, body)
    
    res.status(202).send(update)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_12-e94e45dbba62c1124258682649ad7fbd.png" width="891" height="602"></p>
<h4 id="delete-user">Delete User</h4>
<p><em>src/controller/controller.controller.ts</em></p>
<pre><code class="language-js">export const DeleteUser = async (req: Request, res: Response) =&gt; {
    const deleteUser = await repository.delete(req.params.id)
    
    res.status(204).send(deleteUser)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_13-d90abfd4b23ba0dc78d8dedc597b70c8.png" width="891" height="547"></p>
<h3 id="user-role-model">User Role Model</h3>
<p>Create a new database table to define user roles:</p>
<p><em>src/entities/role.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, PrimaryGeneratedColumn } from &quot;typeorm&quot;;

@Entity ()
export class Role extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: any;

    @Column()
    name: string;

}
</code></pre>
<p>And link this role into the User table:</p>
<p><em>src/entities/role.entity.ts</em></p>
<pre><code class="language-js">@Entity ()
export class User extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: any;

    @Column()
    firstName: string;

    @Column()
    lastName: string;

    @Column({ unique: true })
    email: string;

    @Column()
    password: string;

    @ManyToOne(() =&gt; Role)
    @JoinColumn({name: &#x27;role_id&#x27;})
    role: Role;

}
</code></pre>
<p>For testing we can manually add an <code>Admin</code> role to the table:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_14-0fbba619789fae869f526c140663e4b0.png" width="962" height="464"></p>
<p>And assign this role to existing users in the <code>User</code> table:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_15-f197b5b7e69e0482c205850aa03fa633.png" width="1227" height="512"></p>
<p>Add <code>role</code> to the output of the <code>GetUsers</code> function:</p>
<p><em>src/controller/user.controller.ts</em></p>
<pre><code class="language-js">export const GetUsers = async (req: Request, res: Response) =&gt; {
    const users = await repository.find({
        relations: [&#x27;role&#x27;]
    })

    res.send(
        users.map(user =&gt; {
            const { password, ...data} = user
            return data
        })
    )
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_16-0e3cda486a992b44c94c87e3a1d2eb7c.png" width="898" height="604"></p>
<p>As well as to the <code>CreateUser</code> function:</p>
<p><em>src/controller/user.controller.ts</em></p>
<pre><code class="language-js">export const CreateUser = async (req: Request, res: Response) =&gt; {
    const { role_id, ...body } = req.body;
    const hashedPassword = await bcryptjs.hash(&#x27;pass1234&#x27;, 10);
    const { password, ...user} = await repository.save({
        ...body,
        password: hashedPassword,
        role: {
            id: role_id
        }
    })

    res.status(201).send(user)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_17-44ba166242f39e5a40d79830a0db2368.png" width="895" height="691"></p>
<p>And to the <code>GetUser</code> function:</p>
<p><em>src/controller/user.controller.ts</em></p>
<pre><code class="language-js">export const GetUser = async (req: Request, res: Response) =&gt; {
    const {password, ...user} = await repository.findOne({
        where: { id: req.params.id }, relations: [&#x27;role&#x27;]
    })
    
    res.send(user)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_18-5a364106dbdaa237b2c8a16ae118c202.png" width="888" height="554"></p>
<p>And to the <code>UpdateUser</code> function:</p>
<p><em>src/controller/user.controller.ts</em></p>
<pre><code class="language-js">export const UpdateUser = async (req: Request, res: Response) =&gt; {
    const { role_id, ...body } = req.body;

    await repository.update(req.params.id, {
        ...body,
        role: {
            id: role_id
        }
    });

    const {password, ...user} = await repository.findOne({
            where: { id: req.params.id }, relations: [&#x27;role&#x27;]
        });
    
    res.status(202).send(user)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_19-b62d3c3de7d083be62f8ef20b55ad156.png" width="896" height="694"></p>
<h4 id="user-permissions">User Permissions</h4>
<p>Create a new database table to define user permissions:</p>
<p><em>src/entities/permission.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, PrimaryGeneratedColumn } from &quot;typeorm&quot;;

@Entity ()
export class Permission extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: any;

    @Column()
    name: string;

}
</code></pre>
<p>Permissions are not directly linked to a user but to it&#x27;s role:</p>
<p><em>src/entities/role.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, JoinTable, ManyToMany, PrimaryGeneratedColumn } from &quot;typeorm&quot;;
import { Permission } from &quot;./permission.entity&quot;;

@Entity ()
export class Role extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: any;

    @Column()
    name: string;

    @ManyToMany(() =&gt; Permission)
    @JoinTable({
        name: &#x27;role_permissions&#x27;,
        joinColumn: {
            name: &#x27;role_id&#x27;,
            referencedColumnName: &#x27;id&#x27;
        },
        inverseJoinColumn: {
            name: &#x27;permission_id&#x27;,
            referencedColumnName: &#x27;id&#x27;
        }
    })
    permissions: Permission[];

}
</code></pre>
<p>TypeORM will automatically create a new table <code>role_permissions</code> for us:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_20-282245cce16e9c18ea1bf26882da1064.png" width="1012" height="609"></p>
<h4 id="pre-seeding-roles-and-permissions">Pre-Seeding Roles and Permissions</h4>
<blockquote>
<p>Please check out the <a href="#update-role-seed">Update Role Seed</a> below... the function following here is not working.</p>
</blockquote>
<p>We can add the permissions we want to be able to assign to user roles when the DB connection is established:</p>
<p><em>src/db-connector.ts</em></p>
<pre><code class="language-js">dataSource
    .initialize()
    .then( async () =&gt; {

        // create role permissions
        const permissionRepository = Manager.getRepository(Permission)

        const perms = [
            &#x27;view_users&#x27;,
            &#x27;edit_users&#x27;,
            &#x27;view_roles&#x27;,
            &#x27;edit_roles&#x27;,
            &#x27;view_products&#x27;,
            &#x27;edit_products&#x27;,
            &#x27;view_orders&#x27;,
            &#x27;edit_orders&#x27;
        ]

        let permissions = []

        // insert permissions into Permission table
        for (let i = 0; i&lt; perms.length; i++){
            permissions.push(
                // use upsert instead of save
                await permissionRepository.upsert(
                    { name: perms[i] },
                    // if name exists only update else insert
                    [&#x27;name&#x27;]
                )
            )
        }
        
        console.log(&#x27;INFO :: Data Source has been initialized&#x27;);
    })
    .catch((err) =&gt; {
        console.error(&#x27;ERROR :: Data Source initialization error&#x27;, err);
    })
</code></pre>
<p>After app reloaded the permissions are now added:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_21-685a58ea9b6fd3f04c611f15be8d39d4.png" width="925" height="598"></p>
<p>In the same function we can now add the assignment of permissions to their respective roles:</p>
<p><em>src/db-connector.ts</em></p>
<pre><code class="language-js">// assign permissions to roles
const roleRepository = Manager.getRepository(Role)
// admin can do it all
// insert or update
await roleRepository.upsert({ name: &#x27;Admin&#x27;, permissions }, [&#x27;name&#x27;])

// editor can do all but to edit roles
delete permissions[3]
// insert or update
await roleRepository.upsert({ name: &#x27;Editor&#x27;, permissions }, [&#x27;name&#x27;])
    
// viewer cannot edit anything
delete permissions[1]
delete permissions[5]
delete permissions[7]
// insert or update
await roleRepository.upsert({ name: &#x27;Viewer&#x27;, permissions }, [&#x27;name&#x27;])
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_22-5186f73512b95c0bc2540ba1a7298219.png" width="1011" height="466"></p>
<h4 id="permissions-controller">Permissions Controller</h4>
<p>Check permissions for active user:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.get(&#x27;/api/permissions&#x27;, CheckAuthState, Permissions)
</code></pre>
<p><em>src/controller/permission.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &quot;express&quot;;
import { Permission } from &quot;../entities/permission.entity&quot;;
import Manager from &quot;../db-connector&quot;;

const repository = Manager.getRepository(Permission);

export const Permissions = async (req: Request, res: Response) =&gt; {
    res.send(await repository.find())
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_23-7aef14598e37a57c5e126f5cbc7db5a0.png" width="898" height="559"></p>
<h4 id="role-controller">Role Controller</h4>
<p>Get all available roles:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.get(&#x27;/api/roles&#x27;, CheckAuthState, Roles)
</code></pre>
<p><em>src/controller/roles.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &quot;express&quot;;
import { Roles } from &quot;../entities/roles.entity&quot;;
import Manager from &quot;../db-connector&quot;;

const repository = Manager.getRepository(Roles);

export const Roles = async (req: Request, res: Response) =&gt; {
    res.send(await repository.find())
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_24-56c9fe19f2ab1e8996ad3115ef1483a2.png" width="893" height="511"></p>
<h5 id="manually-adding-roles">Manually Adding Roles</h5>
<p>Create a new role:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.post(&#x27;/api/roles&#x27;, CheckAuthState, CreateRole)
</code></pre>
<p><em>src/controller/roles.controller.ts</em></p>
<pre><code class="language-js">export const CreateRole = async (req: Request, res: Response) =&gt; {
    const { name, permissions } = req.body;
    const role = await repository.save({
        name,
        permissions: permissions.map( id =&gt; {
            return {
                id: id
            }
        })
    })

    res.send(role)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_25-9c262dd4c0b5ec97abc26c31b60a59e0.png" width="893" height="521"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_26-820af782c3397255d26841d8319315a2.png" width="927" height="486"></p>
<h5 id="get-permissions-for-a-role">Get Permissions for a Role</h5>
<p>Return all permissions for a specified role:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.get(&#x27;/api/roles/:id&#x27;, CheckAuthState, CreateRole)
</code></pre>
<p><em>src/controller/roles.controller.ts</em></p>
<pre><code class="language-js">export const GetRole = async (req: Request, res: Response) =&gt; {
    res.send(await repository.findOne({
        where: { id: req.params.id }, relations: [&#x27;permissions&#x27;]
    })
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_27-79e19b3d770843a37ed095b0a8e59384.png" width="885" height="530"></p>
<h5 id="update-permissions-for-a-role">Update Permissions for a Role</h5>
<p>Add permissions for a specified role:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.post(&#x27;/api/roles/:id&#x27;, CheckAuthState, CreateRole)
</code></pre>
<p><em>src/controller/roles.controller.ts</em></p>
<pre><code class="language-js">export const UpdateRole = async (req: Request, res: Response) =&gt; {
    const { name, permissions } = req.body;
    const role = await repository.save({
        id: parseInt(req.params.id),
        name,
        permissions: permissions.map( id =&gt; {
            return {
                id: id
            }
        })
    })
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_28-06ac4180586df1c5018af119b2e7fc9f.png" width="896" height="513"></p>
<h5 id="manually-deleting-roles">Manually Deleting Roles</h5>
<p>Delete an existing role:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">router.delete(&#x27;/api/roles/:id&#x27;, CheckAuthState, DeleteRole)
</code></pre>
<p><em>src/controller/roles.controller.ts</em></p>
<pre><code class="language-js">export const DeleteRole = async (req: Request, res: Response) =&gt; {
    const deleteRole = await repository.delete(req.params.id)

    res.status(204).send(deleteRole)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_29-bb6809a1629198da414ef9048d4d102b.png" width="892" height="486"></p>
<h2 id="products">Products</h2>
<p>Create a table for items to be displayed on the web frontend:</p>
<p><em>src/entities/product.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, Unique, PrimaryGeneratedColumn } from &quot;typeorm&quot;;

@Entity ()
@Unique(&#x27;constraint_name&#x27;, [&#x27;title&#x27;])
export class User extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ unique: true })
    title: string;

    @Column()
    description: string;

    @Column()
    image: string;

    @Column()
    price: number;
}
</code></pre>
<h3 id="product-controller">Product Controller</h3>
<p>The Product routes and  the controller is basically identical to the User pendants:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">// product administration - get all products
router.get(&#x27;/api/products&#x27;, CheckAuthState, GetProducts)
// product administration - get product by ID
router.get(&#x27;/api/products/:id&#x27;, CheckAuthState, GetProduct)
// product administration - create new product
router.put(&#x27;/api/products/:id&#x27;, CheckAuthState, UpdateProduct)
// product administration - create new product
router.post(&#x27;/api/products&#x27;, CheckAuthState, CreateProduct)
// product administration - delete product
router.delete(&#x27;/api/products/:id&#x27;, CheckAuthState, DeleteProduct)
</code></pre>
<p><em>src/controller/product.controller.ts</em></p>
<pre><code class="language-js">
export const GetProducts = async (req: Request, res: Response) =&gt; {
    const products = await repository.find()

    res.send(products)
}


export const CreateProduct = async (req: Request, res: Response) =&gt; {
    const product = await repository.save(req.body)

    res.status(201).send(product)
}


export const GetProduct = async (req: Request, res: Response) =&gt; {
    res.send(await repository.findOne({
        where: { id: parseInt(req.params.id) }
    })
)}

export const UpdateProduct = async (req: Request, res: Response) =&gt; {
    await repository.update(parseInt(req.params.id), req.body);
    
    res.status(202).send(await repository.findOne({
        where: { id: parseInt(req.params.id) }
    }))
}


export const DeleteProduct = async (req: Request, res: Response) =&gt; {
    const deleteProduct = await repository.delete(req.params.id)
    
    res.status(204).send(deleteProduct)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_30-c5fe3f410ed067f4e1fe7840ad6608a0.png" width="893" height="620"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_31-ab1b1d8af868a9e47b6a9dd5d4ad2623.png" width="895" height="651"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_32-ae751f6df766e76c652ce445c692be05.png" width="892" height="623"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_33-17436ffff2ad2008a6e580db12fcd9cb.png" width="886" height="621"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_34-5b9e47509ecafed98edc6f9ef30efe37.png" width="896" height="518"></p>
<h3 id="product-entity">Product Entity</h3>
<p><em>src/entities/product.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, Unique, PrimaryGeneratedColumn } from &quot;typeorm&quot;;

@Entity ()
@Unique(&#x27;constraint_name&#x27;, [&#x27;title&#x27;])
export class Product extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ unique: true })
    title: string;

    @Column()
    description: string;

    @Column()
    image: string;

    @Column()
    price: number;
}
</code></pre>
<h4 id="pre-seeding-products">Pre-Seeding Products</h4>
<p>Use <code>faker</code> to generate items:</p>
<pre><code class="language-bash">npm install @faker-js/faker
</code></pre>
<p><em>src/seeds/product.seed.ts</em></p>
<pre><code class="language-js">import { faker } from &#x27;@faker-js/faker&#x27;
import { Product } from &#x27;../entities/product.entity&#x27;
import { Manager } from &#x27;../db-connector&#x27;

export const productSeed = async () =&gt; {

    // create role permissions
    const productRepository = Manager.getRepository(Product)
    
    // generate 30 fake items
    for (let i = 0; i&lt; 30; i++){
        // use upsert instead of save
        await productRepository.upsert(
            {
                title: faker.lorem.words(2),
                description: faker.lorem.words(10),
                image: faker.image.url({ width: 200, height: 200 }),
                price: parseInt(faker.finance.amount({ min: 500, max: 1000, dec: 2 }))
            },
            // if name exists only update else insert
            [&#x27;title&#x27;]
        )
    }
}
</code></pre>
<p>And use the data source initialization to trigger the seed:</p>
<p><em>src/db-connector.ts</em></p>
<pre><code class="language-js">dataSource
    .initialize()
    .then( () =&gt; {
        roleSeed()
        productSeed()

        console.log(&#x27;INFO :: Data Source has been initialized&#x27;);
    })
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_35-b9f87058347dbf9a5723d6ad395e4db2.png" width="1320" height="797"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_36-baeab54b0104073280dccde7c6fc16c7.png" width="897" height="605"></p>
<h3 id="pagination">Pagination</h3>
<p>Edit the Product Controller to paginate on getProducts:</p>
<p><em>src/controller/product.controller.ts</em></p>
<pre><code class="language-js">export const GetProducts = async (req: Request, res: Response) =&gt; {
    // pagination
    // only retrieve 15 items per page
    const take = 15
    const page = parseInt(req.query.page as string || &#x27;1&#x27;)
    // find &#x27;take&#x27; number of items starting from zero or (page-1)*take
    const [data, total] = await repository.findAndCount({
        take: take,
        skip: ( page - 1 ) * take
    })

    res.send({
        data: data,
        // also return active page, last page and total number of items
        meta: {
            total,
            page,
            last_page: Math.ceil(total / take)
        }
    })
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_37-8055aeda7e102fb628b51349cc9eb341.png" width="888" height="693"></p>
<p>And the same edit for the user table:</p>
<p><em>src/controller/user.controller.ts</em></p>
<pre><code class="language-js">export const GetUsers = async (req: Request, res: Response) =&gt; {
    // pagination
    // only retrieve 15 items per page
    const take = 15
    const page = parseInt(req.query.page as string || &#x27;1&#x27;)
    // find &#x27;take&#x27; number of items starting from zero or (page-1)*take
    const [data, total] = await repository.findAndCount({
        take: take,
        skip: ( page - 1 ) * take,
        relations: [&#x27;role&#x27;]
    })

    res.send({
        data: data.map(user =&gt; {
            const { password, ...data} = user
            return data
        }),
        // also return active page, last page and total number of items
        meta: {
            total,
            page,
            last_page: Math.ceil(total / take)
        }
    })
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_38-8120c30e79cc78f13de3e04c59106eaf.png" width="896" height="692"></p>
<h3 id="file-uploads">File Uploads</h3>
<pre><code class="language-bash">npm install multer @types/multer
</code></pre>
<p>Add multer middleware to upload route:</p>
<p><em>src/controller/role.controller.ts</em></p>
<pre><code class="language-js">// image upload
router.post(&#x27;/api/upload&#x27;, CheckAuthState, FileUpload)
</code></pre>
<p>Add a controller for the file upload:</p>
<p><em>src/controller/upload.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &quot;express&quot;;
import multer from &#x27;multer&#x27;;
import { extname } from &#x27;path&#x27;;


export const FileUpload = async (req: Request, res: Response)  =&gt; {
    const storage = multer.diskStorage({
        destination: &#x27;./uploads&#x27;,
        filename(_, file, cb){
            const randomName = Math.random().toString(20).substring(2, 12)
            return cb(null, `${randomName}${extname(file.originalname)}`)
        }
    })

    const upload = multer({ storage }).single(&#x27;image&#x27;)

    upload(req, res, (err) =&gt; {
        
        if(err){
            return res.send(400).send(err)
        }

        res.send({
            url: `http://localhost:8080/api/uploads/${req.file.filename}`
        })
    })
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_39-09c38bcda00e87228460f1a4ccbc9681.png" width="895" height="479"></p>
<h4 id="static-routes">Static Routes</h4>
<p>To be able to access the uploaded files we need to add static routes:</p>
<p><em>src/controller/role.controller.ts</em></p>
<pre><code class="language-js">// image upload
router.post(&#x27;/api/upload&#x27;, CheckAuthState, FileUpload)
// make upload route public
router.use(&#x27;/api/uploads&#x27;, express.static(&#x27;./uploads&#x27;))
</code></pre>
<h2 id="orders">Orders</h2>
<p>Create tables for incoming order:</p>
<p><em>src/entities/order.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, Unique, PrimaryGeneratedColumn, CreateDateColumn, OneToMany } from &quot;typeorm&quot;;
import { OrderItem } from &quot;./order-item.entity&quot;;

@Entity ()
@Unique(&#x27;constraint_name&#x27;, [&#x27;email&#x27;])
export class Order extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    first_name: string;

    @Column()
    last_name: string;

    @Column()
    email: string;

    @CreateDateColumn()
    created_at: string;

    @OneToMany( () =&gt; OrderItem, OrderItem =&gt; OrderItem.order)
    order_items: OrderItem[];

}
</code></pre>
<p><em>src/entities/order-item.entity.ts</em></p>
<pre><code class="language-js">import { BaseEntity, Column, Entity, Unique, PrimaryGeneratedColumn, ManyToOne, JoinColumn } from &quot;typeorm&quot;;
import { Order } from &quot;./order.entity&quot;;

@Entity ()
@Unique(&#x27;constraint_name&#x27;, [&#x27;product_title&#x27;])
export class OrderItem extends BaseEntity {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    product_title: string;

    @Column()
    price: number;

    @Column()
    quantity: number;

    @ManyToOne( () =&gt; Order)
    @JoinColumn({ name: &#x27;order_id&#x27; })
    order: Order
}
</code></pre>
<h3 id="pre-seeding-orders">Pre-Seeding Orders</h3>
<p><em>src/seeds/order.seed.ts</em></p>
<pre><code class="language-js">import { faker } from &#x27;@faker-js/faker&#x27;;
import { Manager } from &#x27;../db-connector&#x27;
import { Order } from &#x27;../entities/order.entity&#x27;;
import { randomInt } from &#x27;crypto&#x27;;
import { OrderItem } from &#x27;../entities/order-item.entity&#x27;;

export const orderSeed = async () =&gt; {
    
    const orderRepository = Manager.getRepository(Order)
    const orderItemsRepository = Manager.getRepository(OrderItem)
    
    // generate 30 fake orders
    for (let i = 0; i&lt; 30; i++){
        const order = await orderRepository.save(
            {
                first_name: faker.person.firstName(),
                last_name: faker.person.lastName(),
                email: faker.internet.email(),
                created_at: faker.date.recent({ days: 10, refDate: &#x27;2023-06-10T00:00:00.000Z&#x27; })
            }
        );
        console.log(order)
        // add number of items in order
        for(let j = 0; j &lt; randomInt(1,5); j++) {
            await orderItemsRepository.save(
                {
                    product_title: faker.lorem.words(2),
                    price: parseInt(faker.finance.amount({ min: 500, max: 1000, dec: 2 })),
                    quantity: parseInt(faker.finance.amount({ min: 1, max: 5, dec: 0 })),
                    order: order
                }
            )
        }
    }
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_40-08f54f6099c0cff38622688e114d1be9.png" width="1015" height="795"></p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_41-155302793c6a02e31060669196d31ad0.png" width="899" height="792"></p>
<h3 id="order-controller">Order Controller</h3>
<p>Add a route:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">// get all orders
router.get(&#x27;/api/orders&#x27;, CheckAuthState, GetOrders)
</code></pre>
<p><em>src/controller/order.controller.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &quot;express&quot;;

import Manager from &quot;../db-connector&quot;;
import { Order } from &quot;../entities/order.entity&quot;;
const repository = Manager.getRepository(Order);


export const GetOrders = async (req: Request, res: Response) =&gt; {
    // pagination
    // only retrieve 15 items per page
    const take = 15
    const page = parseInt(req.query.page as string || &#x27;1&#x27;)
    // find &#x27;take&#x27; number of items starting from zero or (page-1)*take
    const [data, total] = await repository.findAndCount({
        take: take,
        skip: ( page - 1 ) * take,
        relations: [&#x27;order_items&#x27;]
    })

    res.send({
        data: data.map((Order) =&gt; ({
            id: Order.id,
            name: Order.name,
            email: Order.email,
            total: Order.total,
            created_at: Order.created_at,
            order_items: Order.order_items
        })),
        // also return active page, last page and total number of items
        meta: {
            total,
            page,
            last_page: Math.ceil(total / take)
        }
    })
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_42-9a20f8caab5303ea402edb255c39b160.png" width="898" height="686"></p>
<h4 id="exporting-order-to-csv">Exporting Order to CSV</h4>
<pre><code class="language-bash">npm install json2csv @types/json2csv @types/json2csv
</code></pre>
<p>Add a route:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">// export orders
router.post(&#x27;/api/orders/export/csv&#x27;, CheckAuthState, ExportCsv)
</code></pre>
<p><em>src/controller/order.controller.ts</em></p>
<pre><code class="language-js">export const ExportCsv = async (req: Request, res: Response) =&gt; {
    const parser = new Parser({
        fields: [&#x27;ID&#x27;, &#x27;Name&#x27;, &#x27;Email&#x27;, &#x27;Product&#x27;, &#x27;Price&#x27;, &#x27;Quantity&#x27;]
    })

    const orders = await repository.find({relations: [&#x27;order_items&#x27;]})

    const json = []

    orders.forEach((order:Order) =&gt; {
        json.push({
            ID: order.id,
            Name: order.name,
            Email: order.email,
            Product: &#x27;&#x27;,
            Price: &#x27;&#x27;,
            Quantity: &#x27;&#x27;
        })

        order.order_items.forEach((item: OrderItem) =&gt; {
            json.push({
                ID: &#x27;&#x27;,
                Name: &#x27;&#x27;,
                Email: &#x27;&#x27;,
                Product: item.product_title,
                Price: item.price,
                Quantity: item.quantity
            })
        })
    })

    const csv = parser.parse(json)

    res.header(&#x27;Content-Type&#x27;, &#x27;text/csv&#x27;)
    res.attachment(&#x27;orders.csv&#x27;)
    res.send(csv)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_43-7e7ecba4370da53e811f9a90a53708f3.png" width="895" height="692"></p>
<h4 id="charting-order-data">Charting Order Data</h4>
<p>Add a route:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">// order chart data
router.get(&#x27;/api/orders/chart&#x27;, CheckAuthState, ChartData)
</code></pre>
<p><em>src/controller/order.controller.ts</em></p>
<pre><code class="language-js">export const ChartData = async (req: Request, res: Response) =&gt; {
    const result = await Manager.query(`
        SELECT DATE_FORMAT(o.created_at, &#x27;%Y-%m-%d&#x27;) as date, SUM(oi.price * oi.quantity) as sum
        FROM \`order\` o
            JOIN order_item oi
        on o.id = oi.order_id
        GROUP BY date
    `)

    res.send(result)
}
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_44-91b99c3bb0dce37713fb487be40c9d0b.png" width="895" height="691"></p>
<h2 id="route-permissions">Route Permissions</h2>
<h3 id="update-role-seed">Update Role Seed</h3>
<p>I noticed that the <code>upsert</code> pre-seed created here -&gt; <a href="#pre-seeding-roles-and-permissions">Pre-Seeding Roles and Permissions</a> did not create the role permissions. Which meant that the roles were being created but none of the roles had any permissions assigned to them. Unfortunately, I am not sure where the issue is. So I replace the <code>upsert</code> with a <code>save</code> - and now everything works as expected. With the caveat that you have to make sure that this function is only ever executed once!</p>
<p>To make sure I created a new file for this function:</p>
<p><em>src/seeds/role.preseed.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &#x27;express&#x27;;
import { Permission } from &#x27;../entities/permission.entity&#x27;
import { Role } from &#x27;../entities/role.entity&#x27;
import { Manager } from &#x27;../db-connector&#x27;


export const roleSeed = async (req: Request, res: Response) =&gt; {

    // create role permissions
    const permissionRepository = Manager.getRepository(Permission)

    const perms = [
        &#x27;view_users&#x27;,
        &#x27;edit_users&#x27;,
        &#x27;view_roles&#x27;,
        &#x27;edit_roles&#x27;,
        &#x27;view_products&#x27;,
        &#x27;edit_products&#x27;,
        &#x27;view_orders&#x27;,
        &#x27;edit_orders&#x27;
    ]

    let permissions = []
    
    // insert permissions into Permission table
    for (let i = 0; i&lt; perms.length; i++){
        permissions.push(
            await permissionRepository.save(
                { name: perms[i] }
            )
        )
    }

    // assign permissions to roles
    const roleRepository = Manager.getRepository(Role)
    // admin gets all the permissions
    await roleRepository.save({
        name: &#x27;Admin&#x27;,
        permissions: permissions
    })

    // editor is not allowed to edit roles
    delete permissions[3];

    await roleRepository.save({
        name: &#x27;Editor&#x27;,
        permissions: permissions
    })

    // viewer cannot edit at all
    delete permissions[1];
    delete permissions[5];
    delete permissions[7];

    await roleRepository.save({
        name: &#x27;Viewer&#x27;,
        permissions: permissions
    })

    // // debug
    // console.log(permissions[0].identifiers)
    // console.log(permissions.map(id =&gt; {
    //     return {
    //         id: id.raw[0].id
    //     }}))
    
    res.status(201).send({
        message: &#x27;default user roles created&#x27;
    })
}
</code></pre>
<p>And assigned it to a route so that it can be triggered manually once by visiting the route:</p>
<p><em>src/routes.ts</em></p>
<pre><code class="language-js">// pre-seed roles
router.put(&#x27;/api/preseed/roles&#x27;, roleSeed)
</code></pre>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_45-6537e89cbb36d55ab2df8160c1131240.png" width="895" height="471"></p>
<p>Now the insert works perfectly and all roles have their permissions attached... if you know why <code>upsert</code> don&#x27;t work the same way (and how I could have fixed that) please let me know...</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_46-e90bc5c4137fcdd3e854deba313f37dc.png" width="873" height="799"></p>
<h3 id="permission-middleware">Permission Middleware</h3>
<p>With the role permissions fixed now back to actually implementing the restrictions for every route. Add <code>CheckPermissions</code> function to every route and provide the class <code>users</code>, <code>orders</code>, <code>products</code>, etc. - e.g.:</p>
<pre><code class="language-js">router.get(&#x27;/api/users&#x27;, CheckAuthState, CheckPermissions(&#x27;users&#x27;), GetUsers)
</code></pre>
<p>Create the <code>CheckPermissions</code> function to check if it is a GET route (which only requires <code>view</code> rights) and verify that the users has the corresponding permission. Else <code>edit</code> rights are required:</p>
<p><em>src/middleware/permission.middleware.ts</em></p>
<pre><code class="language-js">import { Request, Response } from &#x27;express&#x27;;
import { User } from &#x27;../entities/user.entity&#x27;;

export const CheckPermissions = (access: string) =&gt; {
    return (req: Request, res: Response, next: Function) =&gt; {
        const user: User = req[&#x27;user&#x27;];
        
        // debug
        // console.log(user[0].role.permissions)

        // get permissions array
        const permissions = user[0].role.permissions

        // loop though array of objects and get permClasses
        const permClasses = []

        for (let i = 0; i &lt; permissions.length; i++) {
            permClasses.push(permissions[i].name)
          }

        // debug
        // console.log(permClasses)

        // if route is GET require `view_` or `edit_` perm else you need `edit_`
        if  (req.method === &#x27;GET&#x27;) {
            if(!permClasses.includes(&#x27;view_&#x27; + access) || !permClasses.includes(&#x27;edit_&#x27; + access)) {
                return res.status(401).send({
                    message: &#x27;ERROR :: Unauthorized!&#x27;
                })
        } else {
            if(!permClasses.includes(&#x27;edit_&#x27; + access)) {
                return res.status(401).send({
                    message: &#x27;ERROR :: Unauthorized!&#x27;
                })
            }
        }}

        next()
    }
}
</code></pre>
<p>Create a user that has the rights to view a given route and one that has not - verify that the latter is blocked from access:</p>
<p><img alt="Node.js 2023" src="/assets/images/Nodejs_Express_2023_47-e921e7ca13a752a649868736e650f083.png" width="902" height="466"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_aHIs padding--none margin-left--sm"><li class="tag_nwHU"><a class="tag_QDqo tagRegular_RTiO" href="/docs/tags/javascript">Javascript</a></li><li class="tag_nwHU"><a class="tag_QDqo tagRegular_RTiO" href="/docs/tags/cheating">Cheating</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Javascript/2023-06-04-nodejs-typescript-sql/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_NulP" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated__GQF"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/javascript"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Javascript</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Development/Javascript/2023-04-01-reactjs-2023/2023-04-01"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">React.js 2023 - A (Re)Introduction</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_IS5x thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#getting-started" class="table-of-contents__link toc-highlight">Getting Started</a><ul><li><a href="#nodejs" class="table-of-contents__link toc-highlight">Node.js</a></li><li><a href="#typescript" class="table-of-contents__link toc-highlight">Typescript</a></li><li><a href="#nodemon" class="table-of-contents__link toc-highlight">Nodemon</a></li></ul></li><li><a href="#webserver" class="table-of-contents__link toc-highlight">Webserver</a><ul><li><a href="#expressjs" class="table-of-contents__link toc-highlight">Express.js</a></li><li><a href="#express-router" class="table-of-contents__link toc-highlight">Express Router</a></li><li><a href="#request-validation" class="table-of-contents__link toc-highlight">Request Validation</a></li></ul></li><li><a href="#database" class="table-of-contents__link toc-highlight">Database</a><ul><li><a href="#sql-database" class="table-of-contents__link toc-highlight">SQL Database</a></li><li><a href="#mysql-connector" class="table-of-contents__link toc-highlight">MySQL Connector</a></li></ul></li><li><a href="#authentication" class="table-of-contents__link toc-highlight">Authentication</a><ul><li><a href="#registering-users" class="table-of-contents__link toc-highlight">Registering Users</a></li><li><a href="#users-login" class="table-of-contents__link toc-highlight">Users Login</a></li><li><a href="#json-web-tokens" class="table-of-contents__link toc-highlight">JSON Web Tokens</a></li><li><a href="#authenticate-users" class="table-of-contents__link toc-highlight">Authenticate Users</a></li><li><a href="#deauthenticate-users" class="table-of-contents__link toc-highlight">Deauthenticate Users</a></li><li><a href="#dotenv" class="table-of-contents__link toc-highlight">Dotenv</a></li><li><a href="#verify-auth-status-middleware" class="table-of-contents__link toc-highlight">Verify Auth Status Middleware</a></li><li><a href="#update-user-info" class="table-of-contents__link toc-highlight">Update User Info</a></li><li><a href="#user-administration" class="table-of-contents__link toc-highlight">User Administration</a></li><li><a href="#user-role-model" class="table-of-contents__link toc-highlight">User Role Model</a></li></ul></li><li><a href="#products" class="table-of-contents__link toc-highlight">Products</a><ul><li><a href="#product-controller" class="table-of-contents__link toc-highlight">Product Controller</a></li><li><a href="#product-entity" class="table-of-contents__link toc-highlight">Product Entity</a></li><li><a href="#pagination" class="table-of-contents__link toc-highlight">Pagination</a></li><li><a href="#file-uploads" class="table-of-contents__link toc-highlight">File Uploads</a></li></ul></li><li><a href="#orders" class="table-of-contents__link toc-highlight">Orders</a><ul><li><a href="#pre-seeding-orders" class="table-of-contents__link toc-highlight">Pre-Seeding Orders</a></li><li><a href="#order-controller" class="table-of-contents__link toc-highlight">Order Controller</a></li></ul></li><li><a href="#route-permissions" class="table-of-contents__link toc-highlight">Route Permissions</a><ul><li><a href="#update-role-seed" class="table-of-contents__link toc-highlight">Update Role Seed</a></li><li><a href="#permission-middleware" class="table-of-contents__link toc-highlight">Permission Middleware</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Research</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Notebook</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/tags">Tags</a></li><li class="footer__item"><a class="footer__link-item" href="/Curriculum-Vitae">CV</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/mike-polinowski-6396ba121/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/MikePolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.flickr.com/people/149680084@N06/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Flickr<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/mpolinowski" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright  2023 Mike Polinowski, INSTAR Deutschland GmbH, Shenzhen - China.</div></div></div></footer></div>
</body>
</html>